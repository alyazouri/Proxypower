function FindProxyForURL(url, host) {

  var FORBID_DIRECT_GLOBAL = false;

  var PROXIES = [
    { ip: "91.106.109.12", ports: [20001,443,8080], weight: 5 },
    { ip: "176.28.250.122", ports: [8080,443],       weight: 3 },
    { ip: "79.173.251.142", ports: [8000,443],       weight: 2 }
  ];

  var JO_IP_SUBNETS = [
    /* قائمة شبكات /24 مدموجة (مؤخوذة من ملفك) */
    ["2.17.24.0","255.255.255.0"],
    ["2.17.25.0","255.255.255.0"],
    ["2.17.26.0","255.255.255.0"],
    ["2.17.27.0","255.255.255.0"],
    ["37.202.64.0","255.255.255.0"],
    ["37.202.65.0","255.255.255.0"],
    ["37.202.66.0","255.255.255.0"],
    ["37.202.67.0","255.255.255.0"],
    ["37.202.68.0","255.255.255.0"],
    ["37.202.69.0","255.255.255.0"],
    ["37.202.70.0","255.255.255.0"],
    ["37.202.71.0","255.255.255.0"],
    ["37.202.72.0","255.255.255.0"],
    ["37.202.73.0","255.255.255.0"],
    ["37.202.74.0","255.255.255.0"],
    ["37.202.75.0","255.255.255.0"],
    ["37.202.76.0","255.255.255.0"],
    ["37.202.77.0","255.255.255.0"],
    ["37.202.78.0","255.255.255.0"],
    ["37.202.79.0","255.255.255.0"],
    ["37.202.80.0","255.255.255.0"],
    ["37.202.81.0","255.255.255.0"],
    ["37.202.82.0","255.255.255.0"],
    ["37.202.83.0","255.255.255.0"],
    ["37.202.84.0","255.255.255.0"],
    ["37.202.85.0","255.255.255.0"],
    ["37.202.86.0","255.255.255.0"],
    ["37.202.87.0","255.255.255.0"],
    ["37.202.88.0","255.255.255.0"],
    ["37.202.89.0","255.255.255.0"],
    ["37.202.90.0","255.255.255.0"],
    ["37.202.91.0","255.255.255.0"],
    ["37.202.92.0","255.255.255.0"],
    ["37.202.93.0","255.255.255.0"],
    ["37.202.94.0","255.255.255.0"],
    ["37.202.95.0","255.255.255.0"],
    ["37.220.112.0","255.255.255.0"],
    ["37.220.113.0","255.255.255.0"],
    ["37.220.114.0","255.255.255.0"],
    ["37.220.115.0","255.255.255.0"],
    ["37.220.116.0","255.255.255.0"],
    ["37.220.117.0","255.255.255.0"],
    ["37.220.118.0","255.255.255.0"],
    ["37.220.119.0","255.255.255.0"],
    ["37.220.120.0","255.255.255.0"],
    ["37.220.121.0","255.255.255.0"],
    ["37.220.122.0","255.255.255.0"],
    ["37.220.123.0","255.255.255.0"],
    ["37.220.124.0","255.255.255.0"],
    ["37.220.125.0","255.255.255.0"],
    ["37.220.126.0","255.255.255.0"],
    ["37.220.127.0","255.255.255.0"],
    ["46.32.96.0","255.255.255.0"],
    ["46.32.97.0","255.255.255.0"],
    ["46.32.98.0","255.255.255.0"],
    ["46.32.99.0","255.255.255.0"],
    ["46.32.100.0","255.255.255.0"],
    ["46.32.101.0","255.255.255.0"],
    ["46.32.102.0","255.255.255.0"],
    ["46.32.103.0","255.255.255.0"],
    ["46.32.104.0","255.255.255.0"],
    ["46.32.105.0","255.255.255.0"],
    ["46.32.106.0","255.255.255.0"],
    ["46.32.107.0","255.255.255.0"],
    ["46.32.108.0","255.255.255.0"],
    ["46.32.109.0","255.255.255.0"],
    ["46.32.110.0","255.255.255.0"],
    ["46.32.111.0","255.255.255.0"],
    ["46.185.128.0","255.255.255.0"],
    ["46.185.129.0","255.255.255.0"],
    ["46.185.130.0","255.255.255.0"],
    ["46.185.131.0","255.255.255.0"],
    ["46.185.132.0","255.255.255.0"],
    ["46.185.133.0","255.255.255.0"],
    ["46.185.134.0","255.255.255.0"],
    ["46.185.135.0","255.255.255.0"],
    ["46.185.136.0","255.255.255.0"],
    ["46.185.137.0","255.255.255.0"],
    ["46.185.138.0","255.255.255.0"],
    ["46.185.139.0","255.255.255.0"],
    ["46.185.140.0","255.255.255.0"],
    ["46.185.141.0","255.255.255.0"],
    ["46.185.142.0","255.255.255.0"],
    ["46.185.143.0","255.255.255.0"],
    ["46.248.192.0","255.255.255.0"],
    ["46.248.193.0","255.255.255.0"],
    ["46.248.194.0","255.255.255.0"],
    ["46.248.195.0","255.255.255.0"],
    ["46.248.196.0","255.255.255.0"],
    ["46.248.197.0","255.255.255.0"],
    ["46.248.198.0","255.255.255.0"],
    ["46.248.199.0","255.255.255.0"],
    ["46.248.200.0","255.255.255.0"],
    ["46.248.201.0","255.255.255.0"],
    ["46.248.202.0","255.255.255.0"],
    ["46.248.203.0","255.255.255.0"],
    ["46.248.204.0","255.255.255.0"],
    ["46.248.205.0","255.255.255.0"],
    ["46.248.206.0","255.255.255.0"],
    ["46.248.207.0","255.255.255.0"],
    ["62.72.160.0","255.255.255.0"],
    ["62.72.161.0","255.255.255.0"],
    ["62.72.162.0","255.255.255.0"],
    ["62.72.163.0","255.255.255.0"],
    ["62.72.164.0","255.255.255.0"],
    ["62.72.165.0","255.255.255.0"],
    ["62.72.166.0","255.255.255.0"],
    ["62.72.167.0","255.255.255.0"],
    ["62.72.168.0","255.255.255.0"],
    ["62.72.169.0","255.255.255.0"],
    ["62.72.170.0","255.255.255.0"],
    ["62.72.171.0","255.255.255.0"],
    ["62.72.172.0","255.255.255.0"],
    ["62.72.173.0","255.255.255.0"],
    ["62.72.174.0","255.255.255.0"],
    ["62.72.175.0","255.255.255.0"],
    ["79.173.192.0","255.255.255.0"],
    ["79.173.193.0","255.255.255.0"],
    ["79.173.194.0","255.255.255.0"],
    ["79.173.195.0","255.255.255.0"],
    ["79.173.196.0","255.255.255.0"],
    ["79.173.197.0","255.255.255.0"],
    ["79.173.198.0","255.255.255.0"],
    ["79.173.199.0","255.255.255.0"],
    ["79.173.200.0","255.255.255.0"],
    ["79.173.201.0","255.255.255.0"],
    ["79.173.202.0","255.255.255.0"],
    ["79.173.203.0","255.255.255.0"],
    ["79.173.204.0","255.255.255.0"],
    ["79.173.205.0","255.255.255.0"],
    ["79.173.206.0","255.255.255.0"],
    ["79.173.207.0","255.255.255.0"],
    ["84.18.32.0","255.255.255.0"],
    ["84.18.33.0","255.255.255.0"],
    ["84.18.34.0","255.255.255.0"],
    ["84.18.35.0","255.255.255.0"],
    ["84.18.36.0","255.255.255.0"],
    ["84.18.37.0","255.255.255.0"],
    ["84.18.38.0","255.255.255.0"],
    ["84.18.39.0","255.255.255.0"],
    ["84.18.40.0","255.255.255.0"],
    ["84.18.41.0","255.255.255.0"],
    ["84.18.42.0","255.255.255.0"],
    ["84.18.43.0","255.255.255.0"],
    ["84.18.44.0","255.255.255.0"],
    ["84.18.45.0","255.255.255.0"],
    ["84.18.46.0","255.255.255.0"],
    ["84.18.47.0","255.255.255.0"],
    ["86.108.0.0","255.255.255.0"],
    ["86.108.1.0","255.255.255.0"],
    ["86.108.2.0","255.255.255.0"],
    ["86.108.3.0","255.255.255.0"],
    ["86.108.4.0","255.255.255.0"],
    ["86.108.5.0","255.255.255.0"],
    ["86.108.6.0","255.255.255.0"],
    ["86.108.7.0","255.255.255.0"],
    ["86.108.8.0","255.255.255.0"],
    ["86.108.9.0","255.255.255.0"],
    ["86.108.10.0","255.255.255.0"],
    ["86.108.11.0","255.255.255.0"],
    ["86.108.12.0","255.255.255.0"],
    ["86.108.13.0","255.255.255.0"],
    ["86.108.14.0","255.255.255.0"],
    ["86.108.15.0","255.255.255.0"],
    ["91.106.96.0","255.255.255.0"],
    ["91.106.97.0","255.255.255.0"],
    ["91.106.98.0","255.255.255.0"],
    ["91.106.99.0","255.255.255.0"],
    ["91.106.100.0","255.255.255.0"],
    ["91.106.101.0","255.255.255.0"],
    ["91.106.102.0","255.255.255.0"],
    ["91.106.103.0","255.255.255.0"],
    ["91.106.104.0","255.255.255.0"],
    ["91.106.105.0","255.255.255.0"],
    ["91.106.106.0","255.255.255.0"],
    ["91.106.107.0","255.255.255.0"],
    ["91.106.108.0","255.255.255.0"],
    ["91.106.109.0","255.255.255.0"],
    ["91.106.110.0","255.255.255.0"],
    ["91.106.111.0","255.255.255.0"],
    ["91.186.224.0","255.255.255.0"],
    ["91.186.225.0","255.255.255.0"],
    ["91.186.226.0","255.255.255.0"],
    ["91.186.227.0","255.255.255.0"],
    ["91.186.228.0","255.255.255.0"],
    ["91.186.229.0","255.255.255.0"],
    ["91.186.230.0","255.255.255.0"],
    ["91.186.231.0","255.255.255.0"],
    ["91.186.232.0","255.255.255.0"],
    ["91.186.233.0","255.255.255.0"],
    ["91.186.234.0","255.255.255.0"],
    ["91.186.235.0","255.255.255.0"],
    ["91.186.236.0","255.255.255.0"],
    ["91.186.237.0","255.255.255.0"],
    ["91.186.238.0","255.255.255.0"],
    ["91.186.239.0","255.255.255.0"],
    ["109.107.224.0","255.255.255.0"],
    ["109.107.225.0","255.255.255.0"],
    ["109.107.226.0","255.255.255.0"],
    ["109.107.227.0","255.255.255.0"],
    ["109.107.228.0","255.255.255.0"],
    ["109.107.229.0","255.255.255.0"],
    ["109.107.230.0","255.255.255.0"],
    ["109.107.231.0","255.255.255.0"],
    ["109.107.232.0","255.255.255.0"],
    ["109.107.233.0","255.255.255.0"],
    ["109.107.234.0","255.255.255.0"],
    ["109.107.235.0","255.255.255.0"],
    ["109.107.236.0","255.255.255.0"],
    ["109.107.237.0","255.255.255.0"],
    ["109.107.238.0","255.255.255.0"],
    ["109.107.239.0","255.255.255.0"],
    ["109.237.192.0","255.255.255.0"],
    ["109.237.193.0","255.255.255.0"],
    ["109.237.194.0","255.255.255.0"],
    ["109.237.195.0","255.255.255.0"],
    ["109.237.196.0","255.255.255.0"],
    ["109.237.197.0","255.255.255.0"],
    ["109.237.198.0","255.255.255.0"],
    ["109.237.199.0","255.255.255.0"],
    ["109.237.200.0","255.255.255.0"],
    ["109.237.201.0","255.255.255.0"],
    ["109.237.202.0","255.255.255.0"],
    ["109.237.203.0","255.255.255.0"],
    ["109.237.204.0","255.255.255.0"],
    ["109.237.205.0","255.255.255.0"],
    ["109.237.206.0","255.255.255.0"],
    ["109.237.207.0","255.255.255.0"]
  ];

  var LOBBY_DOMAINS = [
    "*.pubgmobile.com",
    "*.pubg.com",
    "*.tencentgames.com",
    "*.igamecj.com",
    "login.*",
    "lobby.*",
    "friend.*",
    "social.*",
    "matchmaking.*"
  ];

  var MATCH_DOMAINS = [
    "*.gcloud.qq.com",
    "*.qcloud.com",
    "*.garena.com",
    "*.umeng.com",
    "realtime.*",
    "battle.*",
    "game.*"
  ];

  var SEARCH_DOMAINS = [
    "search.*",
    "find.*",
    "recruit.*",
    "party.*",
    "group.*",
    "matchsearch.*",
    "playersearch.*"
  ];

  var DNS_TTL_BASE_MS = 45000;
  var DNS_TTL_MIN_MS  = 8000;
  var DNS_TTL_MAX_MS  = 300000;
  var PROBE_MIN = 2;
  var PROBE_MAX = 4;
  var PROBE_RATE_LIMIT = 3000;
  var EWMA_ALPHA = 0.28;
  var VAR_ALPHA  = 0.18;
  var STICKY_PORT_TTL = 2700000;
  var SESSION_TTL     = 2700000;
  var SWITCH_FACTOR   = 1.6;
  var MEMORY_SEED_WEIGHT    = 0.65;
  var MEMORY_DECAY_HALFLIFE = 600000;

  if (typeof __JO_SMART === "undefined") {
    __JO_SMART = { dns:{}, stats:{}, sticky:{}, session:{}, memory:{} };
  }

  for (var i=0;i<PROXIES.length;i++){
    var p=PROXIES[i];
    if (!__JO_SMART.stats[p.ip])   __JO_SMART.stats[p.ip]={ewma:null,variance:null,lastProbe:0};
    if (!__JO_SMART.memory[p.ip]) __JO_SMART.memory[p.ip]={mean:null,variance:null,t:0};
  }

  function nowMs(){return(new Date()).getTime()}

  function isJordanIP(ip){
    if(!ip) return false;
    for(var i=0;i<JO_IP_SUBNETS.length;i++){
      if(isInNet(ip, JO_IP_SUBNETS[i][0], JO_IP_SUBNETS[i][1])) return true;
    }
    return false;
  }

  function isYouTube(h){
    var x=(h||"").toLowerCase();
    if(shExpMatch(x,"*.youtube.com")) return true;
    if(shExpMatch(x,"*.googlevideo.com")) return true;
    if(shExpMatch(x,"*.ytimg.com")) return true;
    if(x==="youtu.be"||shExpMatch(x,"youtu.be*")) return true;
    return false;
  }

  function matchList(h,arr){
    for(var i=0;i<arr.length;i++) if(shExpMatch(h,arr[i])) return true;
    return false;
  }

  function dnsCached(name){
    var e=__JO_SMART.dns[name];
    var t=nowMs();
    if(e&&(t-e.t)<(e.ttl||DNS_TTL_BASE_MS)) return e.ip;
    var ip=dnsResolve(name);
    __JO_SMART.dns[name]={ip:ip||null,t:nowMs(),ttl:DNS_TTL_BASE_MS};
    return ip||null;
  }

  function scoreProxy(proxy){
    warmStart(proxy.ip);
    var s=__JO_SMART.stats[proxy.ip];
    var mean=s&&s.ewma!==null?s.ewma:60;
    var variance=s&&s.variance!==null?s.variance:600;
    var vf=1+Math.sqrt(variance)/(1+mean);
    var score=proxy.weight/(1+mean)/vf;
    if(proxy.ports&&proxy.ports.indexOf(20001)!==-1) score*=1.12;
    return score;
  }

  function jordanOnlyList(){
    var out=[];
    for(var i=0;i<PROXIES.length;i++){
      if(isJordanIP(PROXIES[i].ip)) out.push(PROXIES[i]);
    }
    return out;
  }

  function chooseCandidate(hostname){
    var C=jordanOnlyList();
    if(C.length===0) C=PROXIES.slice(0);
    for(var i=0;i<C.length;i++) maybeProbe(C[i]);
    var best=C[0],bestScore=-1e9;
    for(var i=0;i<C.length;i++){
      var sc=scoreProxy(C[i]);
      if(sc>bestScore){bestScore=sc;best=C[i]}
    }
    return best;
  }

  function hashIndex(key,n){
    var h=0; for(var i=0;i<key.length;i++) h=((h<<5)-h)+key.charCodeAt(i);
    return Math.abs(h)%n;
  }

  function stickyPort(hostname,proxy){
    var key=hostname+"@"+proxy.ip;
    var e=__JO_SMART.sticky[key];
    var t=nowMs();
    if(e&&(t-e.t)<STICKY_PORT_TTL) return e.port;
    var ports=proxy.ports&&proxy.ports.length?proxy.ports.slice():[443];
    ports.sort(function(a,b){ if(a===20001) return -1; if(b===20001) return 1; return a-b });
    var idx=hashIndex(hostname,ports.length);
    var port=ports[idx];
    __JO_SMART.sticky[key]={port:port,t:t};
    return port;
  }

  function warmStart(ip){
    var st=__JO_SMART.stats[ip], mem=__JO_SMART.memory[ip];
    if(!st||!mem) return;
    if(st.ewma===null&&mem.mean!==null){
      var w=memoryWeight(mem.t);
      st.ewma=blend(st.ewma,mem.mean,w);
      st.variance=blend(st.variance,mem.variance,w);
    }
  }

  function pinSession(hostname,proxy){
    var s=__JO_SMART.session[hostname], t=nowMs();
    if(!s||!s.ip||(t-s.t)>SESSION_TTL){ __JO_SMART.session[hostname]={ip:proxy.ip,t:t}; return proxy }
    if(s.ip===proxy.ip){ s.t=t; return proxy }
    var current=null;
    for(var i=0;i<PROXIES.length;i++) if(PROXIES[i].ip===s.ip) current=PROXIES[i];
    if(!current){ __JO_SMART.session[hostname]={ip:proxy.ip,t:t}; return proxy }
    var currScore=scoreProxy(current), candScore=scoreProxy(proxy);
    if(candScore>currScore*SWITCH_FACTOR){ __JO_SMART.session[hostname]={ip:proxy.ip,t:t}; return proxy }
    for(var i=0;i<PROXIES.length;i++) if(PROXIES[i].ip===s.ip) return PROXIES[i];
    __JO_SMART.session[hostname]={ip:proxy.ip,t:t}; return proxy;
  }

  function chainProxyJordan(hostname, primaryOnly){
    var L=jordanOnlyList();
    if(L.length===0) return "PROXY 127.0.0.1:9";
    var p1=L[0], p2=L.length>1?L[1]:null;
    var r="PROXY "+p1.ip+":"+stickyPort(hostname,p1);
    if(!primaryOnly && p2) r+="; PROXY "+p2.ip+":"+stickyPort(hostname,p2);
    return r;
  }

  function chainProxyAny(hostname){
    var p1=chooseCandidate(hostname);
    var p2=null;
    for(var i=0;i<PROXIES.length;i++){ if(PROXIES[i].ip!==p1.ip){ p2=PROXIES[i]; break } }
    var r="PROXY "+p1.ip+":"+stickyPort(hostname,p1);
    if(p2) r+="; PROXY "+p2.ip+":"+stickyPort(hostname,p2);
    return r;
  }

  var h=(host||"").toLowerCase();
  if(isYouTube(h)) return "DIRECT";

  var hostIP=dnsCached(h);
  var isJO=hostIP&&isJordanIP(hostIP);

  var isLobby = matchList(h, LOBBY_DOMAINS);
  var isMatch = matchList(h, MATCH_DOMAINS) || h.indexOf("pubg")!==-1 || h.indexOf("tencent")!==-1;
  var isSearch = matchList(h, SEARCH_DOMAINS) || h.indexOf("search")!==-1 || h.indexOf("find")!==-1 || h.indexOf("recruit")!==-1 || h.indexOf("party")!==-1 || h.indexOf("group")!==-1;

  if (isMatch) return chainProxyJordan(h, false);
  if (isLobby) return chainProxyJordan(h, false);
  if (isSearch) return chainProxyJordan(h, false);

  if (isJO && !FORBID_DIRECT_GLOBAL) return "DIRECT";

  if (FORBID_DIRECT_GLOBAL) return chainProxyJordan(h, false);

  return chainProxyAny(h);
}
